name: Build and Release

on:
  push:
    branches:
      - main

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  version-check:
    name: Check Version Update
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.version_changed }}
      version: ${{ steps.check.outputs.version }}
      extension_changed: ${{ steps.check.outputs.extension_changed }}
      docs_changed: ${{ steps.check.outputs.docs_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version updated
        id: check
        run: |
          # Get current version
          CURRENT_VERSION=$(cat VERSION)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Get previous version (from parent commit)
          git show HEAD^:VERSION > /tmp/prev_version 2>/dev/null || echo "0.0.0" > /tmp/prev_version
          PREV_VERSION=$(cat /tmp/prev_version | tr -d '\n')

          echo "Current version: $CURRENT_VERSION"
          echo "Previous version: $PREV_VERSION"

          # Check if VERSION file changed
          if [ "$CURRENT_VERSION" != "$PREV_VERSION" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "✅ Version changed: $PREV_VERSION → $CURRENT_VERSION"
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "⏭️ No version change detected, skipping release"
          fi

          # Check if Extension version matches
          EXT_VERSION=$(grep '"version"' Extension/package.json | head -1 | sed 's/.*"version": *"\([^"]*\)".*/\1/')
          if [ "$CURRENT_VERSION" = "$EXT_VERSION" ]; then
            echo "extension_changed=true" >> $GITHUB_OUTPUT
            echo "✅ Extension version matches: $EXT_VERSION"
          else
            echo "extension_changed=false" >> $GITHUB_OUTPUT
            echo "⚠️ Extension version mismatch: expected $CURRENT_VERSION, got $EXT_VERSION"
          fi

          # Check if Documentation version matches
          DOCS_VERSION=$(grep '"version"' Documentation/package.json | head -1 | sed 's/.*"version": *"\([^"]*\)".*/\1/')
          if [ "$CURRENT_VERSION" = "$DOCS_VERSION" ]; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
            echo "✅ Documentation version matches: $DOCS_VERSION"
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
            echo "⚠️ Documentation version mismatch: expected $CURRENT_VERSION, got $DOCS_VERSION"
          fi

      - name: Summary
        run: |
          echo "## Version Check Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.version_changed }}" = "true" ]; then
            echo "✅ **Version updated to v${{ steps.check.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          else
            echo "⏭️ **No version change - Release skipped**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Extension | ${{ steps.check.outputs.extension_changed == 'true' && '✅ Synced' || '⚠️ Out of sync' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ steps.check.outputs.docs_changed == 'true' && '✅ Synced' || '⚠️ Out of sync' }} |" >> $GITHUB_STEP_SUMMARY

  test-and-build:
    name: Test & Build
    needs: version-check
    if: needs.version-check.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ needs.version-check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.6"
          cache: true

      - name: Test with coverage
        run: |
          go test ./test/... -race -coverprofile=coverage.out -coverpkg=./src/... -timeout 120s
          go tool cover -func=coverage.out | grep total

      - name: Install packaging tools
        run: |
          sudo apt-get update && sudo apt-get install -y ruby ruby-dev rubygems rpm -qq &
          curl -fsSL https://raw.githubusercontent.com/nexoral/xpack/main/Scripts/installer.sh | sudo bash - &
          wait
          sudo gem install fpm --no-document

      - name: Build all platforms
        run: |
          mkdir -p dist/{windows-amd64,windows-386,macos-intel,macos-arm,linux}
          GOOS=windows GOARCH=amd64 go build -o dist/windows-amd64/banglacode.exe . &
          GOOS=windows GOARCH=386 go build -o dist/windows-386/banglacode.exe . &
          GOOS=darwin GOARCH=amd64 go build -o dist/macos-intel/banglacode . &
          GOOS=darwin GOARCH=arm64 go build -o dist/macos-arm/banglacode . &
          GOOS=linux GOARCH=amd64 go build -o dist/linux/banglacode . &
          wait

      - name: Package artifacts
        run: |
          VERSION=${{ needs.version-check.outputs.version }}
          cd dist/windows-amd64 && zip -r ../banglacode-windows-amd64.zip banglacode.exe &
          cd dist/windows-386 && zip -r ../banglacode-windows-386.zip banglacode.exe &
          cd dist/macos-intel && zip -r ../banglacode-macos-amd64.zip banglacode &
          cd dist/macos-arm && zip -r ../banglacode-macos-arm64.zip banglacode &
          wait
          cd dist/linux && xpack -i ./banglacode -app banglacode -arch amd64 -v $VERSION && mv dist/*.deb ../banglacode-linux-amd64.deb
          tar -czvf dist/banglacode-linux-amd64.tgz -C dist/linux banglacode
          fpm -s dir -t rpm -n banglacode -v $VERSION --architecture x86_64 \
            --description "BanglaCode - Bengali Programming Language" \
            --url "https://github.com/AKN414-IND/BanglaCode" --license "MIT" \
            dist/linux/banglacode=/usr/local/bin/banglacode
          mv *.rpm dist/banglacode-linux-amd64.rpm

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          retention-days: 1
          path: |
            dist/banglacode-windows-amd64.zip
            dist/banglacode-windows-386.zip
            dist/banglacode-macos-amd64.zip
            dist/banglacode-macos-arm64.zip
            dist/banglacode-linux-amd64.deb
            dist/banglacode-linux-amd64.rpm
            dist/banglacode-linux-amd64.tgz

  release:
    needs: [version-check, test-and-build]
    if: needs.version-check.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.check_release.outputs.exists == 'false' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: VERSION

      - name: Check if release exists
        id: check_release
        run: |
          VERSION=${{ needs.version-check.outputs.version }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          gh release view "v$VERSION" &>/dev/null && echo "exists=true" >> $GITHUB_OUTPUT || echo "exists=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        if: steps.check_release.outputs.exists == 'false'
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: Create Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version-check.outputs.version }}
          name: BanglaCode v${{ needs.version-check.outputs.version }}
          body: |
            ## BanglaCode v${{ needs.version-check.outputs.version }}

            ### Downloads

            **Windows:**
            - `banglacode-windows-amd64.zip` - Windows 64-bit
            - `banglacode-windows-386.zip` - Windows 32-bit

            **macOS:**
            - `banglacode-macos-amd64.zip` - macOS Intel
            - `banglacode-macos-arm64.zip` - macOS Apple Silicon

            **Linux:**
            - `banglacode-linux-amd64.deb` - Debian/Ubuntu
            - `banglacode-linux-amd64.rpm` - Fedora/RHEL
            - `banglacode-linux-amd64.tgz` - Generic Linux

            ### VSCode Extension
            - Install from [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=AnkanSaha.banglacode)
          files: |
            dist/banglacode-windows-amd64.zip
            dist/banglacode-windows-386.zip
            dist/banglacode-macos-amd64.zip
            dist/banglacode-macos-arm64.zip
            dist/banglacode-linux-amd64.deb
            dist/banglacode-linux-amd64.rpm
            dist/banglacode-linux-amd64.tgz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old releases (keep last 3)
        if: steps.check_release.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          releases=$(gh release list --limit 100 --json tagName --jq '.[].tagName')
          count=$(echo "$releases" | wc -l)
          [ "$count" -gt 3 ] && echo "$releases" | tail -n +4 | xargs -I {} gh release delete {} --cleanup-tag -y || true

  publish-vscode-extension:
    needs: [version-check, release]
    if: |
      needs.version-check.outputs.version_changed == 'true' &&
      needs.version-check.outputs.extension_changed == 'true' &&
      needs.release.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: Extension

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: Extension/package-lock.json

      - name: Build and publish extension
        working-directory: Extension
        run: |
          npm ci --prefer-offline
          npx vsce package
          npx vsce publish -p ${{ secrets.AZURE_DEVOPS_VS_CODE_EXTENSION_PUBLISH_TOKEN }}
